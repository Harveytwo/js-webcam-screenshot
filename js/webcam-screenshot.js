/*! js-webcam-screenshot v0.1.0, 2014-05-14 */
!function(a,b){"use strict";var c=a.navigator.getUserMedia||a.navigator.webkitGetUserMedia||a.navigator.mozGetUserMedia||a.navigator.msGetUserMedia||null,d=c&&a.FormData?!0:!1;d&&(a.navigator._webcamScreenshotgetUserMedia=c);var e={VERSION:"0.1.0",DEFAULT_POST_FIELDNAME:"image",getIsSpported:function(){return d},RC:{OK:0,USER_CANCELLED:1,UNSUPPORTED_BROWSER:2,CANT_ACCESS_WEBCAM:3,SAVE_CALLBACKERROR:4,SAVE_FAILED:5},go:function(c,f){if(f||(f=function(){}),!d)return void f(e.RC.UNSUPPORTED_BROWSER,"Browser is not supported.");switch(c=b.extend(!0,{parent:a.document.body,width:300,cancelText:"Cancel",takeText:"Take it",dialogFramework:"",dialogTitle:"Screenshot from webcam"},c||{}),c.dialogFramework){case"bs2":case"bs3":case"jQueryUI":break;default:c.dialogFramework=""}var g=a.document.createElement("video"),h=null,i=null,j=null,k=null,l=function(){h&&h.css({width:b(a).width(),height:b(a).height()}),i&&!c.dialogFramework&&i.css("left",(b(a).width()-c.width)/2+"px")},m=function(){if(b(a).off("resize",l),h&&(h.remove(),h=null),i){switch(c.dialogFramework){case"bs2":case"bs3":i.modal("hide").remove();break;case"jQueryUI":i.dialog("destroy");break;default:i.remove()}i=null}if(k){try{k.stop()}catch(d){}k=null}},n=function(){m(),f(e.RC.USER_CANCELLED,"User cancelled.")},o=function(){var d;if(c.canvas){var h=[];for(h=c.canvas instanceof b?c.canvas:c.canvas instanceof Array?c.canvas:[c.canvas],d=0;d<h.length;d++)h[d].setAttribute("width",c.width),h[d].setAttribute("height",j),h[d].getContext("2d").drawImage(g,0,0,c.width,j)}if(c.postTo){var i=a.document.createElement("canvas"),k=new a.FormData;if(i.setAttribute("width",c.width),i.setAttribute("height",j),i.getContext("2d").drawImage(g,0,0,c.width,j),e.canvasToFormData(k,c.postFieldname||e.DEFAULT_POST_FIELDNAME,i,c.postImageFormat),c.onBeforePost)try{c.onBeforePost(k)}catch(l){return m(),void f(e.RC.SAVE_CALLBACKERROR,l.message||l.name||l.toString())}return void b.ajax({url:c.postTo,data:k,cache:!1,contentType:!1,processData:!1,type:"POST"}).fail(function(b,c,d){a.alert(d)}).success(function(){m(),f(e.RC.OK)})}m(),f(e.RC.OK)};switch(h=b('<div class="webcamscreenshot-shadow" />'),b(a).on("resize",l),l(),b(c.parent).append(h),c.dialogFramework){case"bs2":i=b(['<div class="modal hide" role="dialog">','<div class="modal-header">','<button type="button" class="close">&times;</button>',"<h3></h3>","</div>",'<div class="modal-body"></div>','<div class="modal-footer"></div>',"</div>",""].join("")),i.find("button.close").on("click",function(){n()}),i.find(".modal-header h3").text(c.dialogTitle),i.find(".modal-body").append(g),i.find(".modal-footer").append(b('<button class="btn" />').html(c.cancelText).on("click",function(){n()})).append(b('<button class="btn btn-primary" />').html(c.takeText).on("click",function(){o()})),b(c.parent).append(i);break;case"bs3":i=b(['<div class="modal">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-header">','<button type="button" class="close">&times;</button>','<h4 class="modal-title"></h4>',"</div>",'<div class="modal-body"></div>','<div class="modal-footer"></div>',"</div>","</div>","</div>",""].join("")),i.find("button.close").on("click",function(){n()}),i.find(".modal-title").text(c.dialogTitle),i.find(".modal-body").append(g),i.find(".modal-footer").append(b('<button type="button" class="btn btn-default" />').html(c.cancelText).on("click",function(){n()})).append(b('<button type="button" class="btn btn-primary" />').html(c.takeText).on("click",function(){o()})),b(c.parent).append(i);break;case"jQueryUI":i=b("<div />"),i.append(g),i.dialog({appendTo:c.parent,autoOpen:!1,closeText:c.cancelText,modal:!0,resizable:!1,title:c.dialogTitle,width:c.width+40,close:function(){m()},buttons:[{text:c.cancelText,click:function(){n()}},{text:c.takeText,click:function(){o()}}]});break;default:i=b('<div class="webcamscreenshot-dialog" />'),b(c.parent).append(i),i.append(g).append(b('<div class="webcamscreenshot-buttons" />').append(b("<button />").html(c.takeText).on("click",function(){o()})).append(b("<button />").html(c.cancelText).on("click",function(){n()})))}g.addEventListener("canplay",function(){j=Math.ceil(c.width*g.videoHeight/g.videoWidth),g.setAttribute("width",c.width),g.setAttribute("height",j)},!1),a.navigator._webcamScreenshotgetUserMedia({video:!0,audio:!1},function(b){if(k=b,a.navigator.mozGetUserMedia)g.mozSrcObject=k;else{var d=a.URL||a.webkitURL;g.src=d&&d.createObjectURL?d.createObjectURL(k):k}switch(g.play(),c.dialogFramework){case"bs2":case"bs3":h.remove(),h=null,i.modal("show");break;case"jQueryUI":h.remove(),h=null,i.dialog("open")}},function(a){m(),f(e.RC.CANT_ACCESS_WEBCAM,a.message||a.name||a.toString())})},canvasToFormData:function(b,c,d,e){var f,g;switch(e){case"jpg":f="image/jpeg",g="image.jpg";break;case"png":default:f="image/png",g="image.png"}var h,i,j=function(a){b.append(c,a,g)};for(i=["getAsFile","getAsBlob","webkitGetAsFile","webkitGetAsBlob","mozGetAsFile","mozGetAsBlob","msGetAsFile","msGetAsBlob"],h=0;h<i.length;h++)if(d[i[h]])return void j(d[i[h]](g));var k,l=d.toDataURL(f).split(",");k=l[0].indexOf("base64")>=0?a.atob(l[1]):a.unescape(l[1]);var m=k.length;if(a.Blob){var n=new Array(m);for(h=0;m>h;h++)n[h]=k.charCodeAt(h);j(new a.Blob([new a.Uint8Array(n)],{type:f}))}else{var o=new a.ArrayBuffer(m),p=new a.Uint8Array(o);for(h=0;m>h;h++)p[h]=k.charCodeAt(h);var q=new a.BlobBuilder;q.append(o),j(q.getBlob(f))}}};a.WebcamScreenshot=e}(window,jQuery);